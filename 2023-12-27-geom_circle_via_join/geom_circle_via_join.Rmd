---
title: "another experiment"
author: "Evangeline Reynolds"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(tidyverse.quiet = TRUE)
```




## Intro Thoughts




## Step 0.  Do it with base ggplot2

```{r}
library(tidyverse)

data.frame(x0 = 0:1, y0 = 0:1, r = 1:2/3) %>% 
  mutate(join = 1) %>% 
  mutate(group = row_number()) %>% 
  left_join(tibble(z = 1:5, join = 1)) %>% 
  mutate(around = 2*pi*z/max(z-1)) %>% 
  mutate(x = x0 + cos(around)*r,
         y = y0 + sin(around)*r) %>% 
  ggplot() + 
  aes(x, y, label = z) +
  geom_text() +
  geom_path(aes(group = group))
```


Step 1. Compute

```{r}
compute_panel_equilateral <- function(data, scales, n = 4){
  
  data %>% 
    mutate(join = 1, 
           group = row_number()) %>% 
  left_join(tibble(z = 1:(n + 1), join = 1)) %>% 
  mutate(around = 2*pi*z/max(z-1)) %>% 
  mutate(x = x0 + cos(around)*r,
         y = y0 + sin(around)*r) 
  
}

tibble(x0 = 1:2, y0 = 1:2, r = 1 ) %>% 
  compute_panel_equilateral()


```

# Step 2. Pass to ggproto

```{r}
StatEquilateral <- ggproto(`_class` = "StatAround", 
                      `_inherit` = ggplot2::Stat,
                      compute_panel = compute_panel_equilateral,
                      required_aes = c("x0", "y0", "r")#,
                      # default_aes = aes(group = row)
                      )
```

## Step 3. Write geom_* or stat_*

```{r}
geom_equilateral <- function(
  mapping = NULL,
  data = NULL,
  position = "identity",
  na.rm = FALSE,
  show.legend = NA,
  inherit.aes = TRUE, ...) {
  ggplot2::layer(
    stat = StatEquilateral,  # proto object from Step 2
    geom = ggplot2::GeomPolygon,  # inherit other behavior
    data = data,
    mapping = mapping,
    position = position,
    show.legend = show.legend,
    inherit.aes = inherit.aes,
    params = list(na.rm = na.rm, ...)
  )
}
```



# Step 4: Enjoy (test)

```{r}
data.frame(x0 = 0:1, y0 = 0:1, r = 1:2/3) %>% 
  ggplot() + 
  aes(x0 = x0, y0 = y0, r = r) + 
  geom_equilateral() + 
  aes(fill = r)

diamonds %>% 
  slice_sample(n = 80) %>% 
  ggplot() + 
  aes(x0 = cut %>% as.numeric, y0 = carat  , r = clarity %>% as.numeric()/20) + 
  geom_equilateral(alpha = .2) + 
  aes(fill = after_stat(r)) +
  coord_equal()


cars %>% 
  ggplot() + 
  aes(x0 = speed, y0 = dist, r = speed/dist) + 
  geom_equilateral()
  

cars %>% 
  sample_n(12) %>%  
  ggplot() + 
  aes(x0 = speed, y0 = dist, r = 3) + 
  geom_equilateral(color = "black") +
  coord_equal()

last_plot() + 
  aes(alpha = speed > 15)



last_plot() + 
  aes(linetype = dist > 20)


last_plot() + 
  aes(fill = speed > 20)


layer_data()

last_plot() + 
  facet_wrap(~ dist > 40)


```


## Closing remarks, Other Relevant Work, Caveats
